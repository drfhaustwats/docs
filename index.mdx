---
title: "Watts v3 controller"
description: "Dual-MCU ESP32 outdoor lighting system with synchronized LED control across Wi-Fi and BLE interfaces"
---

# Dual-MCU ESP32 Outdoor Lighting System

This documentation covers the Watts v3 controller firmware architecture, designed as a high-performance dual-MCU outdoor lighting system with synchronized LED control and robust communication protocols.

## System Architecture Overview

The Watts v3 controller implements a sophisticated dual-MCU topology that separates concerns while maintaining tight synchronization:

```
+-------------------------------------------------------------+
|                      ESP32-C5 (Main)                        |
|  • WLED Effects Engine (Arduino component)                  |
|  • Wi-Fi 2.4 / 5 GHz STA/AP + Ethernet (W5500)              |
|  • ParlIO TX 1-bit @ 30 MHz + VALID pin → pixel stream      |
|  • RMT-TX Channel 0,1 → Local LED Strips                    |
|  • AT-Host task over UART0                                  |
|  • I2C Master → Watts Power Board                           |
+-----------------------▲-------------------------------------+
                        | 30 MHz ParlIO (DATA / CLK / VALID)
                        | Frame-select header + Ch-0/1/2/3 pixels
+-----------------------▼-------------------------------------+
|                    ESP32 WROOM (Secondary)                  |
|  • AT-Firmware Core (NimBLE + Parser)                       |
|  • BLE 5.2 Peripheral                                       |
|  • ParlIO/SPI-Slave DMA RX                                  |
|  • RMT-TX Channel 0,1,2,3 → All 4 LED Strips                |
+-------------------------------------------------------------+
                        ▼
+-------------------------------------------------------------+
|                   Watts Power Board (I2C)                   |
|  • 4× INA237 Power Monitors (current/voltage/temp)          |
|  • STM32 Slave (A3942 motor driver control)                 |
|  • TCA9555 I/O Expander (W5500 reset, GPIO)                 |
|  • Automatic overcurrent protection & clearing              |
+-------------------------------------------------------------+
```

## MCU Role Separation

| Responsibility | ESP32-C5 (Main) | ESP32 WROOM (Secondary) |
|---|---|---|
| **LED Channels** | Ch-0, Ch-1 (local RMT-TX) | Ch-0, Ch-1, Ch-2, Ch-3 (all RMT-TX) |
| **Effects Engine** | WLED renders full 4-channel frame | Mirrors pixel data |
| **Pixel Transport** | ParlIO TX, 30 MHz + VALID | ParlIO/SPI-Slave DMA RX |
| **Network Stack** | Wi-Fi 2.4/5 GHz, Ethernet (W5500) | BLE (GAP + GATT) |
| **Power Monitoring** | I2C master for power board | N/A |
| **AT Protocol Role** | Master / Host | Slave / Device |

## Key Features

### Real-Time Synchronization
- **Sub-5µs latency** between MCU pixel output starts
- **Frame-locked rendering** with acknowledgment protocol
- **30 MHz ParlIO** high-speed inter-MCU communication

### Triple Network Interfaces
- **Wi-Fi Control**: Full WLED web interface, REST API, and UDP sync
- **Ethernet Control**: Wired W5500 connection for reliable network access
- **BLE Control**: Low-power mobile control for basic operations
- **Seamless Handoff**: Configurations synchronized between interfaces

### Integrated Power Management
- **4-Channel Power Monitoring**: Real-time current, voltage, power, and temperature sensing via INA237
- **Automatic Overcurrent Protection**: Intelligent detection and clearing with configurable retry logic
- **A3942 Motor Driver Control**: STM32-based LED driver management with fault monitoring
- **LED Auto-Detection**: Automatic RGB/RGBW detection based on current signatures

### Arduino Component Integration
Built on proven Arduino ecosystem components:
- **WLED Effects Engine**: Industry-standard lighting effects library
- **AsyncTCP & ESPAsyncWebServer**: Non-blocking network stack
- **Custom AT Command Framework**: Efficient inter-MCU communication
- **NimBLE Stack**: Lightweight Bluetooth implementation

## Communication Architecture

The system uses three primary communication channels:
1. **30 MHz ParlIO**: High-speed pixel data streaming (30 MHz clock, 3.38 MB/s effective data rate)
2. **921.6 kbaud UART**: AT command protocol and firmware updates
3. **Wi-Fi/Ethernet/BLE**: User control interfaces

## Getting Started

Explore the documentation sections for detailed implementation guides, hardware setup, and development workflows for both MCU platforms.