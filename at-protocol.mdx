---
title: "AT Command Protocol"
description: "Inter-MCU communication protocol for ESP32-C5 and ESP32 WROOM coordination"
---

# AT Command Protocol

The AT Command Protocol serves as the primary communication mechanism between the ESP32-C5 (master) and ESP32 WROOM (slave) in the Watts v3 dual-MCU lighting system. This protocol enables configuration synchronization, LED frame coordination, BLE management, and firmware updates.

## Protocol Architecture

### Communication Channel
- **Physical Layer**: UART (921.6 kbaud, 8N1)
- **Flow Control**: Disabled
- **Direction**: Bidirectional with master-slave relationship
- **Framework**: Tiny-CAT AT command parser on ESP32 WROOM

### Message Types

#### 1. AT Commands (C5 → WROOM)
Standard AT command format sent by the master controller:
```
AT+COMMAND[=param1[,param2[,...]]]
```

#### 2. Responses (WROOM → C5)
Standard response patterns from the slave device:
```
OK              # Success
ERROR           # Command failed
+DATA:value     # Data response
```

#### 3. Unsolicited Result Codes - URCs (WROOM → C5)
Asynchronous notifications from slave to master:
```
+LED_DONE               # Frame processing complete
+BLEGATTSRECV:data      # BLE data received
+ERROR:code             # Error notification
```

## Communication Flow

### LED Frame Synchronization
The most critical protocol operation coordinates LED frame rendering across both MCUs:

```
ESP32-C5 (Master)                           ESP32 WROOM (Slave)
        |                                           |
        |  AT+LED_PREP=<8 parameters>               |
        |------------------------------------------>|
        |                                           | (SPI slave ready)
        |              OK                           |
        |<------------------------------------------|
        |                                           |
        |       [30MHz ParlIO stream]               |
        |===========================================>| (Frame data via SPI)
        |                                           |
        |             +LED_DONE                     |
        |<------------------------------------------|
        |                                           |
          (Frame complete, LEDs updated on WROOM)
```

**AT+LED_PREP Parameter Format:**
```
AT+LED_PREP=<ch0_px>,<ch1_px>,<ch2_px>,<ch3_px>,<ch0_fmt>,<ch1_fmt>,<ch2_fmt>,<ch3_fmt>
```
- `chX_px`: Pixel count for channel X (0-1000)
- `chX_fmt`: Format for channel X (3=RGB, 4=RGBW, 0=disabled)

### BLE Configuration Flow
BLE setup and management through AT commands:

```
ESP32-C5 (Master)           ESP32 WROOM (Slave)
        |                           |
        |    AT+BLEINIT=2           |
        |-------------------------->|
        |         OK                |
        |<--------------------------|
        |                           |
        | AT+BLENAME="Watts-Ctrl"   |
        |-------------------------->|
        |         OK                |
        |<--------------------------|
        |                           |
        |   AT+BLEADVSTART          |
        |-------------------------->|
        |         OK                | (BLE advertising active)
        |<--------------------------|
        |                           |
        | +BLEGATTSRECV:48656C6C6F  |
        |<--------------------------| (BLE data from client)
        |                           |
     (Process BLE data for lighting control)
```

## Command Categories

### Configuration Commands
Commands for system initialization and setup:
- **AT+BLEINIT**: Initialize BLE stack
- **AT+BLENAME**: Set device name
- **AT+RST**: System restart

### LED Control Commands  
High-speed LED frame coordination:
- **AT+LED_PREP**: Prepare frame reception
- **AT+LED_STATS**: Get statistics
- **AT+LED_RESET**: Reset controller

### BLE Operations
Bluetooth Low Energy management:
- **AT+BLEADVSTART/STOP**: Advertising control
- **AT+BLESVC/CHAR**: Service/characteristic queries
- **AT+BLEREAD/WRITE**: Data operations

### Maintenance Commands
System maintenance and updates:
- **AT+OTAUPDATE**: Firmware update
- **AT+XSET**: Debug/test operations

## Error Handling

### Response Codes
| Response | Meaning | Action |
|----------|---------|---------|
| `OK` | Command succeeded | Continue operation |
| `ERROR` | Command failed | Retry or fallback |
| `HOLD` | Command processing | Wait for completion |

### Timeout Management
- **Standard Commands**: 1000ms timeout
- **LED_PREP**: 100ms timeout (time-critical)
- **OTA Operations**: 30000ms timeout
- **BLE Operations**: 5000ms timeout

### Error Recovery
1. **Command Timeout**: Retry up to 3 times
2. **UART Errors**: Reset communication channel
3. **Frame Sync Loss**: Send `AT+LED_RESET`
4. **BLE Errors**: Reinitialize BLE stack

## Performance Characteristics

### Throughput
- **Command Rate**: ~1000 commands/second
- **LED Frame Rate**: Up to 60 FPS with sub-5µs coordination
- **BLE Latency**: &lt;50ms for characteristic operations

### Reliability Features
- **CRC Protection**: Frame data integrity
- **Acknowledgment**: Positive confirmation required
- **Software Buffering**: Queue-based command management
- **Automatic Retry**: Built-in error recovery

## Integration Points

### C5 Implementation (ATHost)
```cpp
// Send LED preparation command
bool result = ATHost_sendATWaitOK("AT+LED_PREP=500,300", 100);

// Wait for frame completion
if (ATHost_waitLedDone(50)) {
    // Frame processed successfully
}
```

### WROOM Implementation (Tiny-CAT)
```c
// Command handler registration in at_led_commands.c
static struct cat_command spi_led_at_commands[] = {
  {
    .name = "+LED_PREP",
    .description = "Prepare LED frame: +LED_PREP=<ch0_px>,<ch1_px>,...",
    .write = at_cmd_led_prep_spi,
    .disable = false
  }
};
```

### WLED Integration
The protocol integrates seamlessly with WLED through the NeoPixelBus framework:
```cpp
// AT command generation with 8-parameter format
// ch0-ch3 pixel counts + ch0-ch3 formats (3=RGB, 4=RGBW, 0=disabled)
snprintf(cmd, sizeof(cmd), "AT+LED_PREP=%d,%d,%d,%d,%d,%d,%d,%d",
         ch0_px, ch1_px, ch2_px, ch3_px,
         ch0_fmt, ch1_fmt, ch2_fmt, ch3_fmt);
ATHost_sendATWaitOK(cmd, 100);
```

## Protocol Extensions

The AT command framework supports easy extension for new functionality:

1. **Register New Commands**: Add handlers to appropriate category files
2. **Define Response Format**: Follow established patterns
3. **Implement Host Methods**: Add corresponding ATHost functions
4. **Update Documentation**: Include in API reference

This extensible design allows the protocol to grow with system requirements while maintaining backward compatibility and performance characteristics.

## Source Code References

| Component | File | Description |
|-----------|------|-------------|
| **AT LED Commands** | `at_led_commands.c` | `at_cmd_led_prep_spi()` handler, command registration |
| **AT LED Header** | `at_led_commands.h` | `at_led_init()`, `at_led_deinit()` interfaces |
| **Tiny-CAT Framework** | `cat.c`, `cat.h` | AT command parser and dispatcher |
| **UART Configuration** | `EspAt_firmware.c` | UART initialization, baud rate setup |

## Next Steps

For detailed command syntax and parameters, see the [AT Command API Reference](/api-reference/at-commands/overview). For implementation examples, refer to the ESP32-C5 and ESP32 WROOM specific firmware documentation.