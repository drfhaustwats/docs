---
title: "Hardware & Pinouts"
description: "ESP32-C5 and ESP32 WROOM hardware specifications, GPIO assignments, inter-MCU connections, and power board integration"
---

# Hardware Architecture & Pinouts

This section details the hardware specifications, GPIO pin assignments, and physical connections for both microcontrollers in the Watts v3 dual-MCU lighting system, plus the integrated Watts Power Board.

## ESP32-C5 Main Controller

### Overview & Specifications
The ESP32-C5 serves as the primary controller, handling Wi-Fi connectivity, WLED effects processing, and coordination of the entire lighting system.

**Key Capabilities:**
- **CPU**: RISC-V dual-core, up to 240 MHz
- **Wi-Fi**: 2.4/5 GHz 802.11ax (Wi-Fi 6)
- **Memory**: 4MB Flash, 512KB SRAM
- **Peripherals**: RMT (40 MHz), ParlIO, UART, SPI, I2C, ADC
- **Role**: WLED effects engine, Wi-Fi interface, AT command master

### ESP32-C5 GPIO Pin Assignments

#### Inter-MCU Communication (ParlIO)
| GPIO | Function | Description |
|------|----------|-------------|
| 10 | ParlIO Clock Output | 80 MHz clock signal to H2 |
| 25 | ParlIO Valid Signal | Frame synchronization to H2 |
| 26 | ParlIO Data | Pixel data transmission to H2 (WLED 3rd LED output) |

#### UART Communication (AT Host)
| GPIO | Function | Description |
|------|----------|-------------|
| 1 | UART RX | Receives AT responses from WROOM |
| 6 | UART TX | Sends AT commands to WROOM |

#### System & Debug
| GPIO | Function | Description |
|------|----------|-------------|
| 27 | RGB LED | Built-in status indicator |
| 11 | Debug UART TX | Serial console output |
| 12 | Debug UART RX | Serial console input |

#### Power Board I2C Interface
| GPIO | Function | Description |
|------|----------|-------------|
| 7 | I2C SDA | Watts Power Board data line |
| 9 | I2C SCL | Watts Power Board clock line |

**I2C Configuration:**
- **Frequency**: 100 kHz
- **Devices**: TCA9555 expander (0x21), 4× INA237 (0x40-0x4C), STM32 slave (0x50), Main expander (0x20)
- **Purpose**: Power monitoring, W5500 reset control, overcurrent protection

#### SPI Interface (W5500 Ethernet)
| GPIO | Function | Description |
|------|----------|-------------|
| 5 | SPI MISO | W5500 data in |
| 6 | SPI MOSI | W5500 data out |
| 4 | SPI SCK | W5500 clock |
| 12 | SPI CS | W5500 chip select |

**W5500 Configuration:**
- **Host**: SPI2_HOST
- **Frequency**: 8 MHz
- **Reset**: Controlled via power board TCA9555 expander
- **Interrupt**: Not connected (polling mode)

#### Expandable I/O
| GPIO | Function | Description |
|------|----------|-------------|
| 1-6 | ADC (A0-A5) | Analog input channels |
| 2-3 | LP I2C | Low-power device interface |
| 4-5 | LP UART | Low-power serial interface |

---

## ESP32 WROOM Secondary Controller

### Overview & Specifications
The ESP32 WROOM functions as a dedicated LED processor and BLE interface, handling all 4 LED channels and low-power connectivity.

**Key Capabilities:**
- **CPU**: Xtensa dual-core, up to 240 MHz
- **BLE**: Bluetooth 5.0 (Dual Mode - BLE + Classic)
- **Memory**: 4MB Flash, 520KB SRAM
- **Peripherals**: RMT (40 MHz), SPI Slave, UART, NeoPixelBus
- **Role**: BLE interface, 4-channel LED control, AT command slave

### ESP32 WROOM GPIO Pin Assignments

#### Inter-MCU Communication (UART)
| GPIO | Function | Description |
|------|----------|-------------|
| 2 | UART TX | Sends AT responses to C5 |
| 3 | UART RX | Receives AT commands from C5 |

**UART Specifications:**
- **Baud Rate**: 921.6 kbaud (921,600 bps)
- **Flow Control**: Disabled
- **Format**: 8N1 (8 data bits, no parity, 1 stop bit)
- **Port**: UART_NUM_0

#### Data Reception (SPI Slave Mode)
| GPIO | Function | Description |
|------|----------|-------------|
| 10 | SPI Clock Input | 80 MHz clock from C5 |
| 11 | SPI MOSI | Pixel data from C5 |
| 25 | SPI Chip Select | Frame sync from C5 |

#### LED Output (RMT Channels via NeoPixelBus)
| GPIO | Function | Description |
|------|----------|-------------|
| Configurable | RMT Channel 0 | LED Strip Output Ch-0 (RGB/RGBW) |
| Configurable | RMT Channel 1 | LED Strip Output Ch-1 (RGB/RGBW) |
| Configurable | RMT Channel 2 | LED Strip Output Ch-2 (RGB/RGBW) |
| Configurable | RMT Channel 3 | LED Strip Output Ch-3 (RGB/RGBW) |

**NeoPixelBus Configuration:**
- **Resolution**: 40 MHz RMT clock for precise WS2812/SK6812 timing
- **Channels**: All 4 channels (0-3) allocated dynamically based on AT+LED_PREP command
- **Protocols**: WS2812 (RGB, 3 bytes/pixel) and SK6812 (RGBW, 4 bytes/pixel)
- **Memory**: Type-erased strip management for efficient memory usage

---

## Inter-MCU Physical Connections

### Primary Communication Bus
The two MCUs are connected via high-speed parallel interface and UART:

```
ESP32-C5 (Master)           ESP32 WROOM (Slave)
─────────────────           ────────────────────
GPIO 10 (ParlIO CLK)  ────► GPIO 10 (SPI SCLK)
GPIO 26 (ParlIO DATA) ────► GPIO 11 (SPI MOSI)
GPIO 25 (ParlIO VALID)────► GPIO 25 (SPI CS)

GPIO 6  (UART TX)     ────► GPIO 3  (UART RX)
GPIO 1  (UART RX)     ◄──── GPIO 2  (UART TX)

GND                   ────── GND
3.3V                  ────── 3.3V
```

### Communication Specifications

#### High-Speed Pixel Data
- **Protocol**: ParlIO (C5) → SPI Slave (H2)
- **Clock Rate**: 80 MHz
- **Data Width**: 1-bit serial
- **Frame Size**: Up to 8,008 bytes
- **Synchronization**: VALID pin for frame boundaries

#### Control & Status
- **Protocol**: UART with AT commands
- **Baud Rate**: 921.6 kbaud
- **Flow Control**: Disabled
- **Format**: 8N1
- **Direction**: Bidirectional
- **Use Cases**: Configuration sync, firmware updates, status reporting

### Power & Grounding
Both MCUs operate at **3.3V logic levels**. Ensure:
- Common ground connection
- Stable 3.3V power supply for both units
- Proper decoupling capacitors near each MCU
- Signal integrity for high-speed (20 MHz) connections

---

## Configuration Notes

### Pin Conflict Resolution
- **GPIO 25 on C5**: Hardcoded as ParlIO VALID signal; assigned to WLED Channel 4 as placeholder (not used for LED output)
- **GPIO 26 on C5**: Configured as 3rd LED output in WLED, used for ParlIO data transmission
- **GPIO 10-11 on H2**: SPI input pins, no conflicts with RMT output channels

### Configurable Options
All pin assignments can be modified via:
- **C5**: `#define` macros in header files
- **H2**: `uart_set_pin()` and peripheral configuration
- **LED Pins**: RMT channel assignment via configuration

### Signal Quality Requirements
- **Rise/Fall Times**: < 5ns for 80 MHz operation
- **Cable Length**: Keep inter-MCU connections under 5cm
- **EMI Shielding**: Consider shielded cables for production units
- **Ground Plane**: PCB should have continuous ground plane

### WLED Integration Notes
- **GPIO 26 Configuration**: Set as 3rd LED output in WLED hardware configuration
- **GPIO 25 Usage**: Assigned to WLED Channel 4 as placeholder (WLED requires a pin assignment but this pin is not used for LED output)
- **ParlIO Override**: GPIO 25 is hardcoded in ParlIO implementation as VALID signal, regardless of WLED Channel 4 initialization
- **Pin Manager**: WLED pin manager automatically configures ParlIO data pin (GPIO 26) based on 3rd LED output selection

---

## Watts Power Board

### Overview
The Watts Power Board is an I2C-based power monitoring and management system that provides real-time current, voltage, power, and temperature monitoring for all 4 LED channels, plus automatic overcurrent protection and W5500 ethernet controller reset management.

### I2C Device Topology

| Device | I2C Address | Function | Channels |
|--------|-------------|----------|----------|
| **TCA9555 I/O Expander** | 0x21 | Power board GPIO control, W5500 reset | - |
| **INA237 Power Monitor 1** | 0x40 | Current/voltage/power/temp sensing | Channel 0 |
| **INA237 Power Monitor 2** | 0x44 | Current/voltage/power/temp sensing | Channel 1 |
| **INA237 Power Monitor 3** | 0x48 | Current/voltage/power/temp sensing | Channel 2 |
| **INA237 Power Monitor 4** | 0x4C | Current/voltage/power/temp sensing | Channel 3 |
| **Main Board Expander** | 0x20 | System GPIO (reserved) | - |
| **STM32 Slave** | 0x50 | A3942 motor driver control (optional) | 4 channels |

**Connection to ESP32-C5:**
- **SDA**: GPIO 7
- **SCL**: GPIO 9
- **Frequency**: 100 kHz
- **Access Pattern**: Serialized via FreeRTOS I2C worker task

### Hardware Features

#### INA237 Power Monitors (4× channels)
- **Current Range**: ±16A per channel
- **Current Resolution**: 0.1 mA
- **Voltage Range**: 0-85V bus voltage
- **Voltage Resolution**: 1 mV
- **Temperature**: On-die sensor, 1°C resolution
- **Overcurrent Detection**: Hardware ALERT pin with configurable threshold

#### TCA9555 I/O Expander
- **GPIO Pins**: 16 programmable I/O
- **W5500 Reset Control**: Dedicated GPIO for ethernet controller reset
- **ALERT Monitoring**: Reads overcurrent ALERT signals from INA237 monitors
- **Configuration**: Input/output direction per pin, polarity inversion

#### STM32 Slave (Optional)
- **A3942 Control**: 4-channel H-bridge motor driver control for LED outputs
- **Fault Monitoring**: Open load, short to ground, short to battery, overtemperature
- **Enable/Disable**: Per-channel and global output control
- **Fault Clearing**: Automatic and manual fault flag clearing

### Power Monitoring Capabilities

**Measured Parameters:**
- **Current (mA)**: Real-time LED strip current draw per channel
- **Voltage (mV)**: Bus voltage monitoring
- **Power (mW)**: Calculated from I × V
- **Temperature (°C)**: INA237 die temperature
- **Alert Flags**: Overcurrent, undervoltage, overvoltage, temperature warnings

**Update Rate:**
- **Monitor Task**: 50ms polling interval (20 Hz)
- **Snapshot**: Cached measurements with mutex protection
- **Direct Read**: On-demand I2C transaction

### Automatic Overcurrent Protection

The power board implements intelligent overcurrent detection and automatic clearing:

**Detection:**
- INA237 ALERT pin monitoring every 50ms
- Hardware threshold configured at initialization
- Latched overcurrent mask (bit 0-3 for channels 0-3)

**Clearing Sequence:**
1. Wait 5 seconds (configurable) after detection
2. Read INA237 DIAG_ALERT register (clears software latch)
3. Send STM32 clear command (clears A3942 hardware fault)
4. Poll ALERT pin for 1 second to verify stability
5. If failed, retry every 60 seconds (configurable) up to 10 attempts (configurable)

**Logging:**
- All overcurrent events logged with ESP_LOG
- Clear success/failure tracked
- A3942 fault states decoded and displayed

### W5500 Ethernet Integration

The power board controls the W5500 ethernet controller's reset line:

**Reset Sequence:**
1. Set RESET pin LOW via TCA9555 GPIO
2. Wait 10ms
3. Set RESET pin HIGH
4. Wait 100ms for W5500 boot completion

**W5500 SPI Connection (to ESP32-C5):**
- **MISO**: GPIO 5
- **MOSI**: GPIO 6
- **SCK**: GPIO 4
- **CS**: GPIO 12
- **RST**: Controlled via power board TCA9555
- **INT**: Not connected (polling mode)
- **Frequency**: 8 MHz

### Thread Safety

All power board I2C operations are thread-safe via FreeRTOS worker task pattern:

**I2C Worker Task:**
- Dedicated task serializes all I2C transactions
- Queue-based operation submission
- Binary semaphore for completion signaling
- Prevents bus contention from multiple tasks

**Mutex Protection:**
- Snapshot data protected by mutex
- Safe concurrent reads from multiple contexts

### LED Auto-Detection Integration

The power board enables WLED to automatically detect LED types based on current signatures:

**Detection Process:**
1. Set all pixels to known color (e.g., white)
2. Sample current on all 4 channels
3. Classify based on current draw:
   - High current (>500mA) → RGBW strip detected
   - Medium current (200-500mA) → RGB strip detected
   - Low current (<200mA) → No strip or disconnected
4. Configure NeoPixelBus instances accordingly

See [power-board.mdx](power-board.mdx) for complete API reference and usage examples.