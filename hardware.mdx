---
title: "Hardware & Pinouts"
description: "ESP32-C5 and ESP32 WROOM hardware specifications, GPIO assignments, inter-MCU connections, and power board integration"
---

# Hardware Architecture & Pinouts

This section details the hardware specifications, GPIO pin assignments, and physical connections for both microcontrollers in the Watts v3 dual-MCU lighting system, plus the integrated Watts Power Board.

## ESP32-C5 Main Controller

### Overview & Specifications
The ESP32-C5 serves as the primary controller, handling Wi-Fi connectivity, WLED effects processing, and coordination of the entire lighting system.

**Key Capabilities:**
- **CPU**: RISC-V dual-core, up to 240 MHz
- **Wi-Fi**: 2.4/5 GHz 802.11ax (Wi-Fi 6)
- **Memory**: 4MB Flash, 512KB SRAM
- **Peripherals**: RMT (40 MHz), ParlIO, UART, SPI, I2C, ADC
- **Role**: WLED effects engine, Wi-Fi interface, AT command master

### ESP32-C5 GPIO Pin Assignments

#### UART Communication (AT Host)
| GPIO | Function | Description |
|------|----------|-------------|
| 1 | UART TX | Sends AT commands to WROOM |
| 27 | UART RX | Receives AT responses from WROOM |

#### WROOM Control Signals
| GPIO | Function | Description |
|------|----------|-------------|
| 26 | WR_EN | WROOM reset/enable control |
| 27 | WR_BOOT | WROOM boot mode control |

#### I2S Audio Interface
| GPIO | Function | Description |
|------|----------|-------------|
| 0 | I2S SD | Serial data |
| 2 | I2S WS | Word select (L/R clock) |
| 3 | I2S SCK | Serial clock |

#### Power Board I2C Interface
| GPIO | Function | Description |
|------|----------|-------------|
| 7 | I2C SDA | Watts Power Board data line |
| 9 | I2C SCL | Watts Power Board clock line |

**I2C Configuration:**
- **Frequency**: 100 kHz
- **Devices**: TCA9555 expander (0x21), 4× INA237 (0x40-0x4C), STM32 slave (0x50), Main expander (0x20)
- **Purpose**: Power monitoring, W5500 reset control, overcurrent protection

#### SPI Interface (W5500 Ethernet)
| GPIO | Function | Description |
|------|----------|-------------|
| 8 | SPI MOSI | W5500 data out |
| 10 | SPI MISO | W5500 data in |
| 23 | SPI SCK | W5500 clock |
| 28 | SPI CS | W5500 chip select |

**W5500 Configuration:**
- **Host**: SPI2_HOST
- **Frequency**: 8 MHz
- **Reset**: Controlled via power board TCA9555 expander
- **Interrupt**: Not connected (polling mode)

---

## ESP32 WROOM Secondary Controller

### Overview & Specifications
The ESP32 WROOM functions as a dedicated LED processor and BLE interface, handling all 4 LED channels and low-power connectivity.

**Key Capabilities:**
- **CPU**: Xtensa dual-core, up to 240 MHz
- **BLE**: Bluetooth 5.0 (Dual Mode - BLE + Classic)
- **Memory**: 4MB Flash, 520KB SRAM
- **Peripherals**: RMT (40 MHz), SPI Slave, UART, NeoPixelBus
- **Role**: BLE interface, 4-channel LED control, AT command slave

### ESP32 WROOM GPIO Pin Assignments

#### Inter-MCU Communication (UART)
| GPIO | Function | Description |
|------|----------|-------------|
| 1 | UART TX | Sends AT responses to C5 |
| 3 | UART RX | Receives AT commands from C5 |

**UART Specifications:**
- **Baud Rate**: 921.6 kbaud (921,600 bps)
- **Flow Control**: Disabled
- **Format**: 8N1 (8 data bits, no parity, 1 stop bit)
- **Port**: UART_NUM_0

#### Data Reception (SPI Slave Mode)
| GPIO | Function | Description |
|------|----------|-------------|
| 18 | SPI Clock Input | 30 MHz clock from C5 |
| 23 | SPI MOSI | Pixel data from C5 |
| 5 | SPI Chip Select | Frame sync from C5 |

#### LED Output (RMT Channels via NeoPixelBus)
| GPIO | Function | Description |
|------|----------|-------------|
| 4 | RMT Channel 0 | LED Strip Output Ch-0 (RGB/RGBW) |
| 16 | RMT Channel 1 | LED Strip Output Ch-1 (RGB/RGBW) |
| 17 | RMT Channel 2 | LED Strip Output Ch-2 (RGB/RGBW) |
| 25 | RMT Channel 3 | LED Strip Output Ch-3 (RGB/RGBW) |

**NeoPixelBus Configuration:**
- **Resolution**: 40 MHz RMT clock for precise WS2812/SK6812 timing
- **Channels**: All 4 channels (0-3) allocated dynamically based on AT+LED_PREP command
- **Protocols**: WS2812 (RGB, 3 bytes/pixel) and SK6812 (RGBW, 4 bytes/pixel)
- **Memory**: Type-erased strip management for efficient memory usage

---

## Inter-MCU Physical Connections

### Primary Communication Bus
The two MCUs are connected via high-speed parallel interface and UART:

```
ESP32-C5 (Master)           ESP32 WROOM (Slave)
─────────────────           ────────────────────
GPIO 23 (ParlIO CLK)  ────► GPIO 18 (SPI SCLK)
GPIO 8  (ParlIO DATA) ────► GPIO 23 (SPI MOSI)
GPIO 28 (ParlIO VALID)────► GPIO 5  (SPI CS)

GPIO 1  (UART TX)     ────► GPIO 3  (UART RX)
GPIO 27 (UART RX)     ◄──── GPIO 1  (UART TX)

GPIO 26 (WR_EN)       ────► EN (Reset/Enable)
GPIO 27 (WR_BOOT)     ────► GPIO 0 (Boot mode)

GND                   ────── GND
3.3V                  ────── 3.3V
```

### Communication Specifications

#### High-Speed Pixel Data
- **Protocol**: ParlIO (C5) → SPI Slave (H2)
- **Clock Rate**: 30 MHz
- **Data Width**: 1-bit serial
- **Frame Size**: Up to 8,008 bytes
- **Synchronization**: VALID pin for frame boundaries

#### Control & Status
- **Protocol**: UART with AT commands
- **Baud Rate**: 921.6 kbaud
- **Flow Control**: Disabled
- **Format**: 8N1
- **Direction**: Bidirectional
- **Use Cases**: Configuration sync, firmware updates, status reporting

### Power & Grounding
Both MCUs operate at **3.3V logic levels**. Ensure:
- Common ground connection
- Stable 3.3V power supply for both units
- Proper decoupling capacitors near each MCU
- Signal integrity for high-speed (30 MHz) connections

---

## Configuration Notes

### Pin Configuration System
All pin assignments are configured via Kconfig and can be modified via `menuconfig` or by editing `sdkconfig`:

**ESP32-C5 Pin Configuration:**
- Located in `components/pins/Kconfig.projbuild`
- Configured via `CONFIG_PINS_*` symbols in `sdkconfig`
- Includes I2C, SPI, UART, I2S, and control pins

**ESP32 WROOM Pin Configuration:**
- Located in `components/pins/Kconfig.projbuild`
- Configured via `CONFIG_PINS_ESP32_*` and `CONFIG_PINS_SPIS_*` symbols
- Includes UART, SPI slave, and LED output pins

### ParlIO Pin Mapping
The C5 uses its SPI pins for ParlIO communication to the WROOM:
- **ParlIO DATA**: Uses `PINS.spi.mosi` (GPIO 8)
- **ParlIO CLK**: Uses `PINS.spi.sclk` (GPIO 23)
- **ParlIO VALID**: Uses `PINS.spi.cs` (GPIO 28)

These mappings are defined in `C5_PARLIO_*` macros in [NeoEsp32ParlC5SharedManager.h](src/Watts-ESP-IDF-C5/components/NeoPixelBus/src/internal/methods/NeoEsp32ParlC5SharedManager.h)

### Signal Quality Requirements
- **Rise/Fall Times**: < 5ns for 30 MHz operation
- **Cable Length**: Keep inter-MCU connections under 5cm
- **EMI Shielding**: Consider shielded cables for production units
- **Ground Plane**: PCB should have continuous ground plane

---

## Watts Power Board

### Overview
The Watts Power Board is an I2C-based power monitoring and management system that provides real-time current, voltage, power, and temperature monitoring for all 4 LED channels, plus automatic overcurrent protection and W5500 ethernet controller reset management.

### I2C Device Topology

| Device | I2C Address | Function | Channels |
|--------|-------------|----------|----------|
| **Main Board Expander** | 0x20 | Overcurrent interrupt aggregation (POWER_INT on P1.7) | - |
| **Power Board Expander** | 0x21 | Power board GPIO, W5500 reset, ALERT pin monitoring (P1.0-P1.3) | - |
| **INA237 Power Monitor 1** | 0x40 | Current/voltage/power/temp sensing | Channel 0 |
| **INA237 Power Monitor 2** | 0x44 | Current/voltage/power/temp sensing | Channel 1 |
| **INA237 Power Monitor 3** | 0x48 | Current/voltage/power/temp sensing | Channel 2 |
| **INA237 Power Monitor 4** | 0x4C | Current/voltage/power/temp sensing | Channel 3 |
| **STM32 Slave** | 0x50 | A3942 motor driver control (optional) | 4 channels |

**Connection to ESP32-C5:**
- **SDA**: GPIO 7
- **SCL**: GPIO 9
- **Frequency**: 100 kHz
- **Access Pattern**: Serialized via FreeRTOS I2C worker task

### Physical Connectors & Pinouts

#### Main Board Connector (J1 - PH62-14P2-14P22)
Connection to ESP32-C5 main board:

| Pin | Signal | Direction | Description |
|-----|--------|-----------|-------------|
| 1-3 | - | - | Not connected |
| 2 | W5500_CS | Input | W5500 chip select from C5 GPIO 28 |
| 4 | MOSI | Input | SPI data from C5 GPIO 8 |
| 5-6 | - | - | Not connected |
| 7-8 | SPI_INT / I2C_SDA | I/O | SPI interrupt / I2C data (GPIO 7) |
| 9 | I2C_SCL | Input | I2C clock from C5 GPIO 9 |
| 10 | DATA0-DATA3 | Input | Parallel data inputs |
| 11-12 | - | - | Parallel data inputs (continued) |
| 13-14 | 8-60V / GND | Power | Main power input |

#### LED Output Connectors (O2-O5 - RJ45)
Standard RJ45 connectors for each of 4 LED channels:

| Pin | Signal | Description |
|-----|--------|-------------|
| 1 | DRAIN | LED strip drain connection |
| 2 | GATE | MOSFET gate control from A3942 |
| 3 | SOURCE | LED strip source connection |
| 4-8 | - | Reserved for future use |

#### Programming Connector (CN1 - TC2030-CTX-NL)
STM32 programming interface:

| Pin | Signal | Description |
|-----|--------|-------------|
| 1 | VCC | 3.3V power |
| 2 | SWD_SWDIO | Serial wire debug data |
| 3 | NRS'nRST | Reset signal |
| 4 | SWC_SWCLK | Serial wire debug clock |
| 5 | GND | Ground |
| 6 | TDO | Test data output (SWO) |

#### Configuration Connectors
| Connector | Signal | Description |
|-----------|--------|-------------|
| CN4, CN5 | DATA0, DATA1 | Data channel routing (DB126V-5.0-3P-GN) |
| CN6, CN7 | DATA2, DATA3 | Data channel routing (DB126V-5.0-3P-GN) |

### Hardware Features

#### INA237 Power Monitors (4× channels)
- **Current Range**: ±16A per channel
- **Current Resolution**: 0.1 mA
- **Voltage Range**: 0-85V bus voltage
- **Voltage Resolution**: 1 mV
- **Temperature**: On-die sensor, 1°C resolution
- **Overcurrent Detection**: Hardware ALERT pin with configurable threshold

#### TCA9555 I/O Expanders (2×)

**Main Board Expander (0x20):**
- **Port 1, Bit 7 (P1.7)**: POWER_INT input (active low)
  - Aggregates overcurrent alerts from power board
  - Polled by C5 every 50ms for interrupt detection
  - When low, triggers read of power board expander

**Power Board Expander (0x21):**
- **Port 1, Bits 0-3 (P1.0-P1.3)**: INA237 ALERT inputs (active low)
  - P1.0: Channel 0 overcurrent alert
  - P1.1: Channel 1 overcurrent alert
  - P1.2: Channel 2 overcurrent alert
  - P1.3: Channel 3 overcurrent alert
- **W5500 Reset Control**: Dedicated GPIO for ethernet controller reset
- **Configuration Switches**: 3 DIP switches on Port 0 (P0.0-P0.2)

#### STM32 Slave (Optional)
- **A3942 Control**: 4-channel H-bridge motor driver control for LED outputs
- **Fault Monitoring**: Open load, short to ground, short to battery, overtemperature
- **Enable/Disable**: Per-channel and global output control
- **Fault Clearing**: Automatic and manual fault flag clearing

### Power Monitoring Capabilities

**Measured Parameters:**
- **Current (mA)**: Real-time LED strip current draw per channel
- **Voltage (mV)**: Bus voltage monitoring
- **Power (mW)**: Calculated from I × V
- **Temperature (°C)**: INA237 die temperature
- **Alert Flags**: Overcurrent, undervoltage, overvoltage, temperature warnings

**Update Rate:**
- **Monitor Task**: 50ms polling interval (20 Hz)
- **Snapshot**: Cached measurements with mutex protection
- **Direct Read**: On-demand I2C transaction

### Automatic Overcurrent Protection

The power board implements intelligent overcurrent detection and automatic clearing through a **dual-expander two-stage architecture**:

#### Hardware Signal Chain (Active-Low Logic)

```
┌─────────────────────────────────────────────────────────────┐
│ STAGE 1: INA237 ALERT Generation                            │
└─────────────────────────────────────────────────────────────┘

INA237 Sensors (I2C: 0x40, 0x44, 0x48, 0x4C)
  │ Each monitors one LED channel current
  │ ALERT pin asserts LOW when current > configured threshold
  │
  ├─[CH0 ALERT]─> Power Board Expander (0x21) P1.0 ─┐
  ├─[CH1 ALERT]─> Power Board Expander (0x21) P1.1 ─┤
  ├─[CH2 ALERT]─> Power Board Expander (0x21) P1.2 ─┼─> OR logic
  └─[CH3 ALERT]─> Power Board Expander (0x21) P1.3 ─┘   aggregation
                                                        │
                                                        ↓
┌─────────────────────────────────────────────────────────────┐
│ STAGE 2: POWER_INT Aggregation Signal                       │
└─────────────────────────────────────────────────────────────┘

                           POWER_INT (open-drain output)
                              │ Asserts LOW if ANY P1.0-P1.3 is LOW
                              │ Remains HIGH if all alerts clear
                              ↓
                  Main Board Expander (0x20) P1.7 (input pin)
                              │ Monitored by ESP32-C5
                              ↓
                         ESP32-C5 Firmware
```

#### Two-Stage Software Detection (50ms Polling)

**Stage 1 - Fast Pre-Filter:**
```cpp
// Read Main Board Expander (0x20) Port 1
uint8_t p1_main = read_i2c(0x20, TCA_INPUT_P1);

// Check bit 7 (POWER_INT aggregation signal)
bool any_overcurrent = ((p1_main & 0x80) == 0);  // Active LOW
if (!any_overcurrent) return;  // No faults, skip Stage 2
```

**Stage 2 - Channel Identification:**
```cpp
// POWER_INT is active, read which specific channels triggered it
uint8_t p1_power = read_i2c(0x21, TCA_INPUT_P1);

// Check bits 0-3 to identify faulted channels
uint8_t oc_mask = 0;
for (int ch = 0; ch < 4; ch++) {
  if ((p1_power & (1 << ch)) == 0) {  // ALERT active LOW
    oc_mask |= (1 << ch);  // Set bit for this channel
  }
}

// Latch faults (OR operation - sticky until cleared)
s_snapshot.oc_mask |= oc_mask;
```

**Key Design Features:**
- **Two I2C reads only when needed**: Stage 1 filters out 99% of polls when no faults exist
- **Software latching**: Once detected, fault bits remain set until explicitly cleared
- **Dual verification**: Hardware ALERT pins AND software INA237 DIAG_ALERT register (0x0B bit 6)

#### Automatic Clearing Sequence

When `watts_power_clear_oc(channel_mask)` is called (automatically after 5s delay):

**For each faulted channel:**

1. **Clear INA237 Internal Latch** (3 retries):
   ```cpp
   uint16_t diag = read_i2c_16bit(ina_addr[ch], INA237_REG_DIAG_ALERT);
   // Reading DIAG_ALERT clears the INA237's internal overcurrent latch
   ```

2. **Clear STM32C0 A3942 Fault** (5 retries):
   ```cpp
   watts_stm_send_command(0x11 + ch);  // Commands: 0x11, 0x12, 0x13, 0x14
   // Clears motor driver fault flags (short, open load, thermal)
   ```

3. **Verify ALERT Pin Cleared** (500ms polling, 10ms interval):
   ```cpp
   for (50 polls over 500ms) {
     uint8_t p1 = read_i2c(0x21, TCA_INPUT_P1);
     bool alert_clear = ((p1 & (1 << ch)) != 0);  // HIGH = cleared
     if (!alert_clear) {
       // ALERT re-asserted, fault still present
       break;
     }
   }
   // Require 80% of polls HIGH to confirm stable clear
   ```

4. **Update Software Latch**:
   ```cpp
   if (verified_clear) {
     s_snapshot.oc_mask &= ~(1 << ch);  // Clear bit for this channel
   }
   ```

**Retry Logic:**
- **Initial delay**: 5 seconds after first detection
- **Retry interval**: 60 seconds between clear attempts
- **Max attempts**: 10 retries before giving up
- **All configurable** via `watts_power_board.h` macros

#### Logging & Monitoring

```
E POWER_MON: !!! OVERCURRENT CH2 !!!
I POWER_MON: CH2: Current=8234mA, Threshold=8000mA
I POWER_MON: CH2: Attempting clear (attempt 1/10)
I POWER_MON: CH2: ALERT verified clear (48/50 polls HIGH)
I POWER_MON: Channel 2 overcurrent CLEARED
```

### W5500 Ethernet Integration

The power board controls the W5500 ethernet controller's reset line:

**Reset Sequence:**
1. Set RESET pin LOW via TCA9555 GPIO
2. Wait 10ms
3. Set RESET pin HIGH
4. Wait 100ms for W5500 boot completion

**W5500 SPI Connection (to ESP32-C5):**
- **MOSI**: GPIO 8
- **MISO**: GPIO 10
- **SCK**: GPIO 23
- **CS**: GPIO 28
- **RST**: Controlled via power board TCA9555
- **INT**: Not connected (polling mode)
- **Frequency**: 8 MHz

### Thread Safety

All power board I2C operations are thread-safe via FreeRTOS worker task pattern:

**I2C Worker Task:**
- Dedicated task serializes all I2C transactions
- Queue-based operation submission
- Binary semaphore for completion signaling
- Prevents bus contention from multiple tasks

**Mutex Protection:**
- Snapshot data protected by mutex
- Safe concurrent reads from multiple contexts

### LED Auto-Detection Integration

The power board enables WLED to automatically detect LED types based on current signatures:

**Detection Process:**
1. Set all pixels to known color (e.g., white)
2. Sample current on all 4 channels
3. Classify based on current draw:
   - High current (&gt;500mA) → RGBW strip detected
   - Medium current (200-500mA) → RGB strip detected
   - Low current (&lt;200mA) → No strip or disconnected
4. Configure NeoPixelBus instances accordingly

See [power-board.mdx](power-board.mdx) for complete API reference and usage examples.