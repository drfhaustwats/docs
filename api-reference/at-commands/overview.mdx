---
title: "AT Commands Overview"
description: "Complete reference for all AT commands in the dual-MCU lighting system"
---

# AT Commands API Reference

This section provides detailed documentation for all AT commands used in the Watts v3 dual-MCU lighting system (ESP32-C5 + ESP32 WROOM). Commands are organized by functional category.

## Command Categories

### Configuration Commands
System initialization and setup commands:
- [AT+BLEINIT](/api-reference/at-commands/ble#at-bleinit) - Initialize BLE stack
- [AT+BLENAME](/api-reference/at-commands/ble#at-blename) - Set BLE device name
- [AT+RST](/api-reference/at-commands/system#at-rst) - System restart

### LED Control Commands
High-speed LED coordination between MCUs:
- [AT+LED_PREP](/api-reference/at-commands/led#at-led-prep) - Prepare LED frame reception
- [AT+LED_STATS](/api-reference/at-commands/led#at-led-stats) - Get LED controller statistics
- [AT+LED_RESET](/api-reference/at-commands/led#at-led-reset) - Reset LED controller

### BLE Management Commands
Bluetooth Low Energy operations:
- [AT+BLEADVSTART](/api-reference/at-commands/ble#at-bleadvstart) - Start BLE advertising
- [AT+BLEADVSTOP](/api-reference/at-commands/ble#at-bleadvstop) - Stop BLE advertising
- [AT+BLESVC](/api-reference/at-commands/ble#at-blesvc) - List BLE services
- [AT+BLECHAR](/api-reference/at-commands/ble#at-blechar) - List characteristics
- [AT+BLEREAD](/api-reference/at-commands/ble#at-bleread) - Read characteristic value
- [AT+BLEWRITE](/api-reference/at-commands/ble#at-blewrite) - Write characteristic value

### Firmware Management
System maintenance and updates:
- [AT+OTAUPDATE](/api-reference/at-commands/ota#at-otaupdate) - Firmware update over UART

## Command Format

All AT commands follow the standard format:
```
AT+COMMAND[=param1[,param2[,...]]]
```

### Response Types

| Response | Description |
|----------|-------------|
| `OK` | Command executed successfully |
| `ERROR` | Command failed |
| `+DATA:value` | Command returned data |

### Unsolicited Result Codes (URCs)

URCs are asynchronous messages sent by the ESP32 WROOM to notify the ESP32-C5 of events:

| URC | Description |
|-----|-------------|
| `+H2_ALIVE:0` | WROOM alive but not initialized (sent every 10s) |
| `+H2_ALIVE:1` | WROOM alive and fully initialized (sent every 10s) |
| `+LED_DONE` | LED frame processing complete |
| `+BLEGATTSRECV:hexdata` | BLE data received from client |
| `+ERROR:code` | Error notification |

## Communication Protocol

- **UART Settings**: 921.6 kbaud, 8N1, No flow control
- **Timeout**: Variable by command type (100ms - 30s)
- **Direction**: ESP32-C5 (master) â†’ ESP32 WROOM (slave)
- **Framework**: Tiny-CAT AT parser on ESP32 WROOM
- **Heartbeat**: WROOM sends `+H2_ALIVE` every 10 seconds for health monitoring

## Quick Reference

### Most Used Commands

```bash
# Initialize BLE
AT+BLEINIT=2
AT+BLENAME="Watts-Controller"
AT+BLEADVSTART

# LED frame coordination (called automatically by NeoPixelBus)
# 4 channels with pixel counts and formats (3=RGB, 4=RGBW)
AT+LED_PREP=150,200,100,250,3,3,3,3

# System management
AT+LED_STATS
AT+RST
```

### Integration Examples

#### C5 (ATHost) Usage
```cpp
#include "ATHost.h"

// Initialize BLE on WROOM
ATHost_sendATWaitOK("AT+BLEINIT=2", 5000);
ATHost_sendATWaitOK("AT+BLENAME=\"Watts-v3\"", 1000);

// Prepare LED frame (8 parameters: 4 pixel counts + 4 formats)
char cmd[128];
snprintf(cmd, sizeof(cmd), "AT+LED_PREP=%u,%u,%u,%u,%u,%u,%u,%u",
         150, 200, 100, 250,  // pixel counts for channels 0-3
         3, 3, 3, 3);         // formats (3=RGB, 4=RGBW)

if (ATHost_sendATWaitOK(cmd, 1000)) {
    // WROOM ready to receive frame data
    ESP_LOGI("AT", "WROOM configured for 4-channel LED output");
}
```

#### WROOM (Command Handler) Implementation
```c
// File: main/at_led_commands.c
#include "cat.h"

cat_return_state at_led_prep(const struct cat_command *cmd,
                             const uint8_t *data, size_t size, size_t args_num) {
    if (args_num != 8) {
        return CAT_RETURN_STATE_ERROR;  // Require 8 parameters
    }

    // Parse 8 parameters: px[0-3], fmt[0-3]
    uint16_t px[4];
    uint8_t fmt[4];
    for (int i = 0; i < 4; i++) {
        px[i] = /* parse pixel count */;
        fmt[i] = /* parse format */;
    }

    // Configure SPI LED controller
    esp_err_t ret = spi_led_controller_config(px, fmt);
    if (ret != ESP_OK) {
        return CAT_RETURN_STATE_ERROR;
    }

    // Mark system as initialized (heartbeat will now send +H2_ALIVE:1)
    h2_system_initialized = true;

    return CAT_RETURN_STATE_OK;
}
```

#### Heartbeat Monitoring (C5 Side)
```cpp
// File: components/wled/lightpipe_state.h
#include "lightpipe_state.h"

// Parse +H2_ALIVE URCs from WROOM
void onATResponseReceived(const char* response) {
    if (strncmp(response, "+H2_ALIVE:", 10) == 0) {
        bool initialized = (response[10] == '1');

        // Update LightPipe state manager
        lightPipe.onHeartbeatReceived(initialized);

        // Reinitialize if needed
        if (lightPipe.needsReinit() && lightPipe.isAlive()) {
            sendLedPrepCommand();  // Resend AT+LED_PREP
            lightPipe.markLightPipeInitialized();
        }
    }
}
```

## See Also

- **[ESP32-C5 Implementation](../../esp32-c5-implementation.mdx)** - Main controller architecture and NeoPixelBus integration
- **[ESP32 WROOM Implementation](../../esp32-wroom-implementation.mdx)** - Secondary controller with AT firmware and SPI LED controller
- **[AT Protocol Guide](../../at-protocol.mdx)** - Complete protocol specification and communication flow
- **[Frame Data Protocol](../../frame-data-protocol.mdx)** - Binary frame format and CRC validation

This API reference provides comprehensive documentation for all AT commands, enabling developers to understand and extend the dual-MCU communication protocol.